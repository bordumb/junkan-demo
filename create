#!/bin/bash
set -e

echo "ðŸ”§ Configuring Demo Repository..."

# --- 1. Setup V1 (Safe State) ---
# We overwrite files to ensure they are in the 'Safe' state initially
echo "ðŸ“„ Writing baseline infrastructure (V1)..."
mkdir -p terraform
cat > terraform/main.tf << 'EOF'
resource "aws_db_instance" "payment_db" {
  identifier = "payment-db-prod"
  instance_class = "db.t3.micro"
  engine = "postgres"
  username = "dbadmin"
  password = var.db_password
}

# V1 OUTPUT (Safe)
output "payment_db_host" {
  value = aws_db_instance.payment_db.address
  description = "The endpoint for the payment database"
}
EOF

# Ensure src/app.py exists and expects the V1 output
mkdir -p src
cat > src/app.py << 'EOF'
import os
# Expects payment_db_host from Terraform
DB_HOST = os.getenv("PAYMENT_DB_HOST")
def connect():
    if not DB_HOST:
        raise ValueError("Database host not configured!")
    print(f"Connecting to {DB_HOST}...")
EOF

# --- 2. Setup GitHub Workflow ---
echo "ðŸ¤– Configuring GitHub Actions..."
mkdir -p .github/workflows
cat > .github/workflows/jnkn-analysis.yml << 'EOF'
name: Jnkn Impact Analysis
on:
  pull_request:
    types: [opened, synchronize, reopened]
permissions:
  contents: read
  pull-requests: write
jobs:
  impact-analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install Jnkn
        run: pip install jnkn
      - name: Run Analysis
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          jnkn init --force --no-telemetry
          jnkn scan
          jnkn diff origin/${{ github.base_ref }} HEAD --format markdown > report.md
          gh pr comment ${{ github.event.pull_request.number }} --body-file report.md
EOF

# --- 3. Git Baseline (Main) ---
echo "ðŸ’¾ Committing Safe State to 'main'..."
# Initialize if needed
if [ ! -d ".git" ]; then
  git init
  git branch -M main
fi

# Switch to main
git checkout main 2>/dev/null || git checkout -b main

# Add files and commit (allow empty if nothing changed)
git add .
git commit -m "Reset: Safe Baseline (V1)" --allow-empty

# --- 4. Create Feature Branch & Breaking Change ---
echo "ðŸŒ¿ Switching to feature branch 'feature/breaking-change'..."
# Use -B to force reset the branch pointer if it already exists
git checkout -B feature/breaking-change

echo "ðŸ’¥ Introducing Breaking Change (V2)..."
cat > terraform/main.tf << 'EOF'
resource "aws_db_instance" "payment_db" {
  identifier = "payment-db-prod"
  instance_class = "db.t3.micro"
  engine = "postgres"
  username = "dbadmin"
  password = var.db_password
}

# BREAKING CHANGE: Renamed output
output "payment_database_endpoint" {
  value = aws_db_instance.payment_db.address
  description = "The endpoint for the payment database"
}
EOF

# Commit the breaking change
git add terraform/main.tf
git commit -m "Refactor: Rename database output (Breaking)"

echo ""
echo "âœ… Demo Ready!"
echo "--------------------------------------------------------"
echo "You are now on branch: feature/breaking-change"
echo "To trigger the PR comment:"
echo "  1. git push -u origin main"
echo "  2. git push -u origin feature/breaking-change --force"
echo "--------------------------------------------------------"