#!/bin/bash
set -e

# --- Configuration ---
# CHANGE THIS if your tool repo is named differently on GitHub
TOOL_REPO_URL="git+https://github.com/bordumb/jnkn.git@dev-simplify0.0.1Launch"

echo "ðŸ”§ Configuring Demo Repository..."

# --- 1. Setup V1 (Safe State) ---
echo "ðŸ“„ Writing baseline infrastructure (V1)..."
mkdir -p terraform src .github/workflows
cat > terraform/main.tf << 'EOF'
resource "aws_db_instance" "payment_db" {
  identifier = "payment-db-prod"
  instance_class = "db.t3.micro"
  engine = "postgres"
  username = "dbadmin"
  password = var.db_password
}

# V1 OUTPUT (Safe)
output "payment_db_host" {
  value = aws_db_instance.payment_db.address
  description = "The endpoint for the payment database"
}
EOF

cat > src/app.py << 'EOF'
import os
# Expects payment_db_host from Terraform
DB_HOST = os.getenv("PAYMENT_DB_HOST")
def connect():
    if not DB_HOST:
        raise ValueError("Database host not configured!")
    print(f"Connecting to {DB_HOST}...")
EOF

# --- 2. Setup GitHub Workflow ---
echo "ðŸ¤– Configuring GitHub Actions..."
cat > .github/workflows/jnkn-analysis.yml <<EOF
name: Jnkn Impact Analysis
on:
  pull_request:
    types: [opened, synchronize, reopened]
permissions:
  contents: read
  pull-requests: write
jobs:
  impact-analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install Jnkn from Source
        run: pip install "${TOOL_REPO_URL}"

      - name: Run Analysis
        env:
          GH_TOKEN: \${{ secrets.GITHUB_TOKEN }}
        run: |
          # Init
          jnkn init --force --no-telemetry
          
          # Build Graph
          jnkn scan
          
          # Generate Diff Report (Main vs HEAD)
          echo "Running Diff..."
          jnkn diff origin/\${{ github.base_ref }} HEAD --format markdown > report.md
          
          # Debug: Show report in logs
          echo "--- REPORT START ---"
          cat report.md
          echo "--- REPORT END ---"
          
          # Post Comment
          gh pr comment \${{ github.event.pull_request.number }} --body-file report.md
EOF

# --- 3. Git Baseline (Main) ---
echo "ðŸ’¾ Committing Safe State to 'main'..."
if [ ! -d ".git" ]; then
  git init
  git branch -M main
fi

# Reset to main
git checkout main 2>/dev/null || git checkout -b main
git add .
git commit -m "Reset: Safe Baseline (V1)" --allow-empty

# --- 4. Create Feature Branch & Breaking Change ---
echo "ðŸŒ¿ Switching to feature branch 'feature/breaking-change'..."
git checkout -B feature/breaking-change

echo "ðŸ’¥ Introducing Breaking Change (V2)..."
cat > terraform/main.tf << 'EOF'
resource "aws_db_instance" "payment_db" {
  identifier = "payment-db-prod"
  instance_class = "db.t3.micro"
  engine = "postgres"
  username = "dbadmin"
  password = var.db_password
}

# BREAKING CHANGE: Renamed output
output "payment_database_endpoint" {
  value = aws_db_instance.payment_db.address
  description = "The endpoint for the payment database"
}
EOF

git add terraform/main.tf
git commit -m "Refactor: Rename database output (Breaking)"

echo ""
echo "âœ… Demo Ready!"
echo "--------------------------------------------------------"
echo "To trigger the PR:"
echo "1. git push -u origin main"
echo "2. git push -u origin feature/breaking-change --force"
echo "--------------------------------------------------------"