name: "Junkan Impact Gate"

on:
  pull_request:
    paths:
      - 'infra/**'
      - 'app/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  impact-analysis:
    name: "ðŸ›¡ï¸ Impact Analysis"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for git diff

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Junkan
        run: |
          pip install junkan
          # In a real setup, this would install from PyPI or your internal registry

      - name: Run Junkan Gate
        id: junkan
        env:
          # In production, this URL points to Marquez/DataHub
          # For this spike, we point to the local mock file using a file:// URI or relative path handling
          OPENLINEAGE_FILE: "junkan_spike/data/production_lineage.json"
        run: |
          # 1. Parse the mock lineage file (Junkan handles local files transparently if configured)
          # 2. Compare HEAD against the PR base
          # 3. Apply the policy
          
          junkan check \
            --git-diff origin/${{ github.base_ref }} HEAD \
            --policy junkan_spike/policy.yaml \
            --openlineage-file $OPENLINEAGE_FILE \
            --output impact_report.json \
            --format markdown > pr_comment.md

      - name: Post PR Comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const comment = fs.readFileSync('pr_comment.md', 'utf8');
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            } catch (err) {
              console.log("No report generated or error reading file");
            }

      - name: Enforce Gate
        if: steps.junkan.outcome == 'failure'
        run: |
          echo "::error::Junkan detected Critical Impact. Blocking Merge."
          exit 1