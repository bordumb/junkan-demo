name: Jnkn Impact Analysis

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write # Required to post comments

jobs:
  impact-analysis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Important: Fetch full history for diffing

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Jnkn
        # Replace this with how you install your tool. 
        # If it's on PyPI: pip install jnkn
        # For this demo, we'll install from the repo itself if you pushed the source code
        run: |
          pip install jnkn 
          # Or if you pushed the source code to this repo:
          # pip install .

      - name: Run Jnkn Diff & Comment
        env:
          # This token is automatically provided by GitHub Actions
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Initialize to ensure we have a clean state
          jnkn init --force --no-telemetry
          
          # 2. Run Scan to build the graph
          jnkn scan
          
          # 3. Generate the Markdown Report comparing main vs current branch
          # We redirect output to a file to use it in the comment step
          jnkn diff origin/main HEAD --format markdown > report.md
          
          # 4. Post the comment to the PR
          # We use the GitHub CLI (gh) which is pre-installed on runners
          gh pr comment ${{ github.event.pull_request.number }} --body-file report.md